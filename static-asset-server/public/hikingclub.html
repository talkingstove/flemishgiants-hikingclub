<html>
  <head>
    <title>Hiking Club</title>

    <link rel='stylesheet' href='http://localhost:6001/stylesheets/hikingclub.css' />
    <link rel='stylesheet' href='http://localhost:4000/stylesheets/lagomorph/styles.css' />
    <script src="http://localhost:6001/store.js"></script>  

    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    <script src="http://localhost:4000/js/lib/lagomorph/L.js"></script>  


    <script src="http://localhost:6001/userDefinedComponents.js"></script>  
  </head>
  <body>
    <script>

      localDBName = "hiking_club_i8n_database_14";

    // var db = new Dexie("i8n_database");
    //       db.version(1).stores({
    //           i18n: 'key,value'
    //       });

    //       db.i18n.put({key: "key1", value: "This is a test string"});
          
          var db = new Dexie(localDBName);
          var culture = store.get('activeUser').language;
          var tableName = 'i18n_' + culture;
          var stores = {}; //stores = tables
          stores[tableName] = 'key,text';
          stores.latestUpdate = 'id,timestamp';


          db.version(1).stores(stores);
          db.open(); //creates if not created
          // db[tableName].put({i18nkey: "i18nkey1", i18nvalue: "This is a test string for hiking"});
          // db.latestUpdate.put({id: 0, timestamp: ""});
          

      </script>


    <script language="javascript">
      var hasServiceworker = (navigator && navigator.serviceWorker);

      if (hasServiceworker) { //should work chrome, FF, some others... http://caniuse.com/#feat=serviceworkers
        // navigator.serviceWorker.register('lagomorph-sample-service-worker2.js');

        //if qstring cachename, do stuff
      }

      var i18nIP = 'http://10.5.90.59:5000';
      // var now = new Date();
      // var formattedNow = now.getUTCFullYear() + '-' + (now.getUTCMonth()+1) + '-' + now.getUTCDay() + 'T' + now.getUTCHours() + ':' + now.getUTCMinutes() + ':' + now.getUTCSeconds() + '.' + now.getUTCMilliseconds();

      //"2017-09-10T21:32:00.27"

      $(function() {
        var culture = store.get('activeUser').language;

        if (!culture) {
          console.error('No language specified for current user!');
        }

        new Dexie(localDBName).open().then(function (db) {
          db.table('latestUpdate').get(0, function (timestampObj) {
              var timeStampToCall = timestampObj.timestamp || 'init';
              // var timeStampToCall = 'init';


              console.log('ts to call', timestampObj);

              L.initialize({
                services: [
                  {
                    url: 'http://localhost:7001/ajax/site-config.json'
                    //cache/offline behavior can go here
                  },
                  {
                    url:  i18nIP + '/api/Translations/culture/' + culture + '/' + timeStampToCall
                  }
                ],
                userDefinedComponents: userDefinedComponents,
                callback: function(data) {
                  
                  var i18nData;

                  for (var i=0; i<data.length; i++) {
                    if (data[i].returnedData.maxTimestamp) {
                      i18nData = data[i].returnedData;
                      break;
                    }
                  }

                  var translationsReturned = i18nData.translations;
                  var tableName = 'i18n_' + culture;
                  // db.table(tableName).bulkPut(translationsReturned);

                  _.each(translationsReturned, function(obj) {
                    db.table(tableName).put(obj);
                  })

                  // var curi18n = L.uiStringsLibrary.getLibrary().storage.allUiStrings;

                  setTimeout(function() {
                    db.table(tableName).each(function(obj) {
                      L.uiStringsLibrary.getLibrary().storage.allUiStrings.i18n[obj.key] = obj.text;
                    });
                    // _.each(db.table(tableName).toArray(), function(obj) {
                    //   L.uiStringsLibrary.getLibrary().storage.allUiStrings.i18n[obj.key] = obj.text;
                    // });
                  }, 1);
                  

                  db.table('latestUpdate').put({id: 0, timestamp: i18nData.maxTimestamp});
                } //end callback
              });

          });
       });
       

        // L.initialize({
        //   services: [
        //     {
        //       url: 'http://localhost:7001/ajax/site-config.json'
        //       //cache/offline behavior can go here
        //     },
        //     {
        //       url:  i18nIP + '/api/Translations/culture/' + culture + '/' + formattedNow
        //     }
        //   ],
        //   userDefinedComponents: userDefinedComponents,
        //   callback: function(data) {
            
        //     var i18nData;

        //     for (var i=0; i<data.length; i++) {
        //       if (data[i].returnedData.maxTimestamp) {
        //         i18nData = data[i].returnedData;
        //         break;
        //       }
        //     }
        //     //put the i18n stuff we got back into indexedDb
        //     new Dexie(localDBName).open().then(function (db) {

        //          console.log ("Found database: " + db.name);
        //           console.log ("Database version: " + db.verno);
        //           db.tables.forEach(function (table) {
        //           console.log ("Found table: " + table.name);
        //            console.log ("Table Schema: " +
        //            JSON.stringify(table.schema, null, 4));

        //            db.table('latestUpdate').put({id: 0, timestamp: "20171022"});

        //           //  debugger;

        //           //  db.transaction('rw', db.latestUpdate, function() {
        //           //   debugger;
        //           //     db.latestUpdate.add({id: 1, timestamp: "20171012"});
        //           // });
        //     });


            
        //     // //     // debugger;
        //     //     var culture = store.get('activeUser').language;
        //     //     var tableName = 'i18n_' + culture;

        //     //     debugger;
        //     //     // db.latestUpdate.put({timestamp: "abcdeg"});
        //     //     db.transaction('rw', db.latestUpdate, function() {

        //     //         //
        //     //         // Transaction Scope
        //     //         //

        //     //         db[tableName].add({key: "key1", value: "This is a test stsdsring for hiking"});
             

        //     //     }).then(function() {

        //     //         //
        //     //         // Transaction Complete
        //     //         //

        //     //         console.log("Transaction committed");

        //     //     }).catch(function(err) {

        //     //         //
        //     //         // Transaction Failed
        //     //         //

        //     //         console.error(err.stack);
        //     //     });
        //     });



        //   }      
        // });

        
      });
    </script>
    <h1>This is hiking club</h1>


    <div id="page-wrapper">
    </div>
  </body>
</html>